<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Sala</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .header {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px auto;
            color: white;
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
        }

        .search-card {
            background: white;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        /* Estilo unificado para input e select */
        input,
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            /* Garante que o select tenha a mesma apar√™ncia */
            background-color: white; 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 10px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Estilo para campos desabilitados */
        input:disabled,
        select:disabled,
        .btn-search:disabled {
            background-color: #f0f4f8;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-search {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-search:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-search:active:not(:disabled) {
            transform: translateY(0);
        }

        .result {
            background: white;
            padding: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .result.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .result.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .result h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .info-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .info-item span {
            font-size: 18px;
            font-weight: 600;
        }

        .loading {
            background: white;
            padding: 40px;
            border-radius: 0 0 20px 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .footer {
            background: white;
            padding: 20px;
            text-align: center;
            color: #718096;
            font-size: 14px;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }

        .footer-small {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.7;
        }

        @media (max-width: 640px) {
            .header { padding: 30px 20px; }
            h1 { font-size: 24px; }
            .search-card, .result, .loading { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header">
            <div class="logo">üîç</div>
            <h1>Localizador de Sala</h1>
            <p class="subtitle">Consulte seu local de prova.</p>
        </div>
        
        <div class="search-card">
            
            <div class="input-group">
                <label for="dateSelector">1. Selecione a Data da Prova</label>
                <select id="dateSelector">
                    <option value="">Carregando datas...</option>
                </select>
            </div>

            <div class="input-group">
                <label for="studentName">2. Digite o Nome Completo do Aluno</label>
                <input type="text" id="studentName" placeholder="Digite seu nome aqui..." disabled>
            </div>
            
            <button id="searchButton" class="btn-search" onclick="buscarAluno()" disabled>
                Buscar Local
            </button>
        </div>
        
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Buscando...</p>
        </div>

        <div id="result" class="result hidden">
            </div>
        
    </div>

    <footer class="footer">
        <p>Sistema de Ensalamento</p>
        <p class="footer-small">Desenvolvido para a comunidade escolar.</p>
    </footer>

    <script>
        // URL do arquivo JSON (assumindo que ainda √© 'ensalamento.json')
        const DADOS_URL = 'ensalamento.json';
        
        // Vari√°vel global para armazenar todos os dados carregados
        let allEnsalamentoData = [];

        // Refer√™ncias aos elementos do DOM
        const dateSelector = document.getElementById('dateSelector');
        const studentNameInput = document.getElementById('studentName');
        const searchButton = document.getElementById('searchButton');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');

        // 1. Inicia o carregamento dos dados quando a p√°gina √© carregada
        document.addEventListener('DOMContentLoaded', carregarDadosIniciais);

        /**
         * Carrega os dados do JSON, extrai as datas √∫nicas e popula o seletor
         */
        async function carregarDadosIniciais() {
            try {
                const url = `${DADOS_URL}?t=${new Date().getTime()}`; // Preven√ß√£o de cache
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Falha ao carregar o arquivo de ensalamento.');
                }
                
                allEnsalamentoData = await response.json();
                
                if (!Array.isArray(allEnsalamentoData) || allEnsalamentoData.length === 0) {
                     throw new Error('Arquivo de dados vazio ou em formato incorreto.');
                }

                popularSeletorDeDatas(allEnsalamentoData);

            } catch (error) {
                console.error('Erro inicial:', error);
                showError('N√£o foi poss√≠vel carregar os dados das provas. Entre em contato com a escola.');
                dateSelector.innerHTML = `<option value="">Erro ao carregar datas</option>`;
            }
        }

        /**
         * Pega a lista de dados, extrai datas √∫nicas e as coloca no <select>
         */
        function popularSeletorDeDatas(data) {
            // Extrai todas as datas
            const todasAsDatas = data.map(aluno => aluno.data_aplicacao);
            // Filtra para ter apenas datas √∫nicas e remove valores nulos/undefined
            const datasUnicas = [...new Set(todasAsDatas)].filter(Boolean);
            
            // Ordena as datas (mais recente primeiro)
            datasUnicas.sort().reverse(); 
            
            // Limpa o seletor
            dateSelector.innerHTML = '';
            
            // Adiciona a op√ß√£o padr√£o
            dateSelector.add(new Option('Selecione uma data', ''));

            // Adiciona cada data como uma op√ß√£o formatada
            datasUnicas.forEach(isoDate => {
                const dataFormatada = formatarDataBR(isoDate);
                dateSelector.add(new Option(dataFormatada, isoDate));
            });

            // Habilita o seletor de data
            dateSelector.disabled = false;
            
            // Adiciona o "ouvinte" para habilitar o campo de nome
            dateSelector.addEventListener('change', onDateSelectChange);
        }

        /**
         * Habilita/desabilita o campo de nome e bot√£o quando uma data √© selecionada
         */
        function onDateSelectChange() {
            const dataSelecionada = dateSelector.value;
            if (dataSelecionada) {
                studentNameInput.disabled = false;
                searchButton.disabled = false;
                studentNameInput.focus(); // Foca no campo de nome
            } else {
                studentNameInput.disabled = true;
                searchButton.disabled = true;
            }
        }

        /**
         * Fun√ß√£o para normalizar texto (remover acentos e converter para min√∫sculas)
         */
        function normalizeText(text) {
            if (!text) return "";
            return text
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim();
        }

        /**
         * Fun√ß√£o principal de busca (chamada pelo bot√£o)
         */
        function buscarAluno() {
            const dataSelecionada = dateSelector.value;
            const nomeDigitado = studentNameInput.value.trim();
            
            // Valida√ß√µes
            if (!dataSelecionada) {
                showError('Por favor, selecione uma data antes de buscar.');
                return;
            }
            if (nomeDigitado.length < 3) {
                showError('Por favor, digite pelo menos 3 letras do seu nome.');
                return;
            }
            
            // Mostrar loading
            resultDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            const nomeNormalizado = normalizeText(nomeDigitado);

            // Filtra os dados (que j√° est√£o na mem√≥ria)
            const resultados = allEnsalamentoData.filter(aluno => {
                const dataMatch = aluno.data_aplicacao === dataSelecionada;
                const nameMatch = normalizeText(aluno.nome).includes(nomeNormalizado);
                return dataMatch && nameMatch;
            });

            // Esconde o loading
            loadingDiv.classList.add('hidden');

            // Processa os resultados
            if (resultados.length === 1) {
                showSuccess(resultados[0]);
            } else if (resultados.length > 1) {
                showError(`Foram encontrados ${resultados.length} resultados. Por favor, seja mais espec√≠fico (use nome e sobrenome).`);
            } else {
                showError(`Nenhum aluno encontrado com o nome "${nomeDigitado}" para esta data. Verifique a digita√ß√£o.`);
            }
        }

        /**
         * Formata uma data 'AAAA-MM-DD' para 'DD/MM/AAAA'
         */
        function formatarDataBR(isoDate) {
            try {
                const [ano, mes, dia] = isoDate.split('-');
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return isoDate; // Retorna a data original se o formato falhar
            }
        }

        /**
         * Mostra o card de sucesso (adaptado para a nova estrutura de dados)
         */
        function showSuccess(aluno) {
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
                <h2>‚úÖ Localiza√ß√£o Encontrada!</h2>
                
                <div class="info-item">
                    <strong>üë®‚Äçüéì Aluno</strong>
                    <span>${aluno.nome}</span>
                </div>
                
                <div class="info-item">
                    <strong>üìÖ Data da Prova</strong>
                    <span>${formatarDataBR(aluno.data_aplicacao)}</span>
                </div>
                
                <div class="info-item">
                    <strong>üè´ Sala</strong>
                    <span>${aluno.sala}</span>
                </div>
                
                <div class="info-item">
                    <strong>üìç Carteira</strong>
                    <span>${aluno.carteira}</span>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        /**
         * Mostra o card de erro
         */
        function showError(message) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `
                <h2>‚ùå Erro na Consulta</h2>
                <p style="font-size: 16px; line-height: 1.6; margin-top: 15px;">${message}</p>
            `;
            resultDiv.classList.remove('hidden');
        }

        // Permitir busca ao pressionar Enter no campo de nome
        studentNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarAluno();
            }
        });

        // Adiciona um listener ao bot√£o de busca
        searchButton.addEventListener('click', buscarAluno);
        
    </script>

</body>
</html>
